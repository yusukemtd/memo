- [OAuth 2.0 について](#oauth-20-%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
  - [概要](#%E6%A6%82%E8%A6%81)
  - [関連仕様](#%E9%96%A2%E9%80%A3%E4%BB%95%E6%A7%98)
  - [ロール](#%E3%83%AD%E3%83%BC%E3%83%AB)
  - [フロー](#%E3%83%95%E3%83%AD%E3%83%BC)
    - [プロトコルフロー](#%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%83%95%E3%83%AD%E3%83%BC)
    - [フローの選定](#%E3%83%95%E3%83%AD%E3%83%BC%E3%81%AE%E9%81%B8%E5%AE%9A)
    - [認可コードフロー](#%E8%AA%8D%E5%8F%AF%E3%82%B3%E3%83%BC%E3%83%89%E3%83%95%E3%83%AD%E3%83%BC)


# OAuth 2.0 について

## 概要

OAuth 2.0とは、HTTPサービスを利用するサードパーティアプリケーションに対して、限定的なアクセスを可能とするための「認可」フレームワークのこと。

OAuth 2.0では、サードパーティアプリケーションに対してEnd-Userのクレデンシャル（例：ID、パスワード）を開示することなく、リソースへのアクセス権を委譲（認可）する。
OAuth 2.0フローの中で、End-Userにより認可され、発行された情報はアクセストークンと呼ぶ。サードパーティアプリケーションはこのアクセストークンを用いることで、End-Userのリソースへ（許可された範囲での）アクセスが可能となる。

これにより、従来のサーバ・クライアント型の認証モデルにあった以下のような問題を解決する。

- サードパーティアプリケーションにてEnd-Userのアカウント情報を管理する必要がある。
- End-Userは、サードパーティアプリケーションに許可するアクセス可能範囲（アクセス対象のデータ、およびそれに伴う参照、更新などの操作）およびアクセス可能期間を制限することができない。
- サードパーティアプリケーションにおける情報漏えいは、End-UserのID、パスワードの漏洩につながる。

> **「認証」と「認可」の違いについて**
> 
> - 認証（`Authentication`）
>   - ユーザが、そのユーザ本人であることを証明すること。
> - 認可（`Authorization`）
>   - （認証済みの）ユーザに対して権限を委譲すること。
> 
> なお、OAuth 2.0は「認可」のフレームワークであり、認可処理の前段として必要になる、End-Userの「認証」の具体的な方法については特に定めていない。
> OAuth 2.0を利用する際は、[RFC 6819 OAuth 2.0 Threat Model and Security Considerations](https://tools.ietf.org/html/rfc6819) に定められているセキュリティ考慮事項と合わせて、適切な認証方式を検討すること。

## 関連仕様

OAuth 2.0は様々な関連仕様により構成されており、これらを組み合わせることで認可を実現する。
OAuth 2.0の主な関連仕様を以下に示す。

なお、OAuth 2.0についてより詳細を把握したい場合は、下記関連仕様の重要度が高い順に参照することを推奨する。

**OAuth 2.0関連仕様**

| 関連仕様 | 重要度 | 説明             |
| :------ | :---: | :---------------- |
| [RFC 6749 The OAuth 2.0 Authorization Framework](https://tools.ietf.org/html/rfc6749) [(日本語訳)](http://openid-foundation-japan.github.io/rfc6749.ja.html)| 高 | OAuth 2.0のコアとなるプロトコル。アクセストークン発行までのフローを規定。
| [RFC 6750 The OAuth 2.0 Authorization Framework: Bearer Token Usage](https://tools.ietf.org/html/rfc6750) [(日本語訳)](http://openid-foundation-japan.github.io/rfc6750.ja.html)| 高 | アクセストークンを用いてリソースへのアクセスを行う際のフローを規定。
| [RFC 6819 OAuth 2.0 Threat Model and Security Considerations](https://tools.ietf.org/html/rfc6819) [(日本語訳)](http://openid-foundation-japan.github.io/rfc6819.ja.html)| 高 | OAuth 2.0の利用に際して注意すべきセキュリティ上の特徴・注意点。
| [RFC 7636 Proof Key for Code Exchange by OAuth Public Clients](https://tools.ietf.org/html/rfc7636) | 中 | PKCE（ぴくしー）と呼ぶ。後述する、認可コードの横取り攻撃への対策を規定。
| [RFC 7662 OAuth 2.0 Token Introspection](https://tools.ietf.org/html/rfc7662) | 中 | 後述する、リソースサーバがアクセストークンの妥当性を検証するために、認可サーバへ問い合わせる際のフローを規定。
| [RFC 7519 JSON Web Token (JWT)](https://tools.ietf.org/html/rfc7519) | 低 | JWT（じょっと）と呼ぶ。JSONオブジェクトを署名または暗号化しURL-safeな文字列とするための仕様を規定。OAuth 2.0ではアクセストークンをJWTとして発行することもある。また、後述するOpenID Connectでは様々な箇所でJWTを利用している。**TODO:OpenID Connectと合わせて概要執筆予定**
| [RFC 8252 OAuth 2.0 for Native Apps](https://tools.ietf.org/html/rfc8252) | 低 | OAuth 2.0をiOS、Androidなどのネイティブアプリケーションで利用する際の、現時点でのベストプラクティスを規定。本仕様で紹介しているフローではPKCEを適用している。

また参考情報として、Auth 2.0以外で認可を実現する際の関連技術について以下に示す。

**OAuth 2.0以外の認可を実現する関連技術**

| 関連技術        | 説明              |
| :------------- | :---------------- |
| OAuth 1.0      | [RFC 5849](https://tools.ietf.org/html/rfc5849) にて策定されているOAuth 2.0の元となったプロトコル。OAuth 2.0策定に伴い廃止となった。 |
| OpenID Connect | OAuth 2.0をベースとした拡張されたプロトコル。OAuth 2.0では定められていなかった、End-UserのIDやプロフィール情報を連携（ID連携）する方法が追加されている他、よりセキュアな通信を実現するためのパラメータ等の追加、その他関連技をオプションとして規定。**TODO:後ほど概要執筆予定** |
| Financial-grade API  | OpenID Financial API WGが策定を進めている、金融分野においてAPIを提供する際の標準仕様群。JSONデータスキーマ、セキュリティおよびプライバシに関する推奨事項とプロトコルを規定。 |

> **Financial-grade API（FAPI）について**
> 
> FAPIは金融APIの仕様であるが、他分野であってもセキュリティへの考慮事項は参考になるため、参照することを推奨する。
> なお、FAPIが定める、参照系API（例：残高照会）および更新系API（例：口座振込）の要件を定めている [Part1](http://openid.net/specs/openid-financial-api-part-1.html)、[Part2](http://openid.net/specs/openid-financial-api-part-2.html) は 2018/8/1現在、Implementer's Draftであるため、今後策定が進むに伴い変更が入る可能性がある。
> また、Part2で紹介されている [OAuth 2.0 Token Binding [OAUTB]](https://tools.ietf.org/html/draft-ietf-oauth-token-binding-04) はTLSレイヤを改修する必要があり、実現可能となるまで暫く時間がかかると予想される。

## ロール

OAuth 2.0では、以下の4つのロールを定義している。

| ロール        | 説明                   |
| :----------- | :-------------------- |
| リソースオーナ<br>（`resource owner`）  | 保護されたリソースへのアクセスを許可するエンティティ。リソースオーナが人間の場合、End-User。
| リソースサーバ<br>（`resource server`） | 保護されたリソースをホストし、アクセストークンを用いたリソースへのリクエストに対して応答するサーバ。
| クライアント<br>（`client`）            | リソースオーナの認可を得て、リソースオーナの代理として保護されたリソースに対するリクエストを行うアプリケーション。 
| 認可サーバ<br>（`authorization server`）| リソースオーナーの認証とリソースオーナーからの認可取得が成功した後、アクセストークンをクライアントに発行するサーバ。

また、クライアントについては、クライアントのクレデンシャルの機密性を維持できるかどうかで以下の2つに分類される。

| クライアントタイプ                     | 説明                      |
| :---------------------------------- | ------------------------- |
| コンフィデンシャル<br>（`confidential`）| クレデンシャルへのアクセスが制限されたWebサーバ上に実装されたクライアントなど。
| パブリック<br>（`public`）            | iOSやAndroidなどにインストールされたネイティブアプリケーションやブラウザベースのアプリケーショなど、（改ざんなどにより）機密性を維持することができず、かつ他の手段を用いたセキュアなクライアント認証が利用できないクライアント。

> **パブリッククライアントの認証について**
> 
> OAuth 2.0におけるフローでは、クライアントがパブリッククライアントである場合、認証をクライアントを識別する目的で利用してはならず、また認証したパブリッククライアントを **信頼してはならない** とされている。
> そのため、後述するインプリシットグラントフローはパブリッククライアントに最適化されたOAuth 2.0フローであるが、クライアントの認証を行っておらず、セキュリティリスクの高い（ユーザビリティとのトレードオフにより割り切った）フローとなっている。

## フロー

### プロトコルフロー

### フローの選定

### 認可コードフロー

**TODO：後日更新予定**




